# whitelist 
language: java

env:  
  global:  
   - DISPLAY=:99.0
    - REPO=${PWD}/p2repo

sudo: false

dist: xenial

jdk:
  - openjdk11

install: echo 'Skipping mvn install'

before_script:
 - chmod +x build/travis.sh
 - echo "MAVEN_OPTS='-Xmx4g -Xms2g'" > ~/.mavenrc

script:
 - java -version
 - env
   # Make sure stdout is in blocking mode.
   # See https://github.com/travis-ci/travis-ci/issues/4704#issuecomment-348435959 for details.
 - python -c 'import os,sys,fcntl; flags = fcntl.fcntl(sys.stdout, fcntl.F_GETFL); fcntl.fcntl(sys.stdout, fcntl.F_SETFL, flags&~os.O_NONBLOCK);'
 - mvn clean install -D eclipse.p2.mirrors=false -D org.osgi.framework.bundle.parent=ext -D osgi.framework.extensions=org.eclipse.fx.osgi -D baselineMode=warn -D jgit.dirtyWorkingTree=warning -D tycho.localArtifacts=ignore -D csstudio.composite.repo=${REPO} -D skipTests=true -N
 - cd maven-osgi-bundles mvn clean install -D eclipse.p2.mirrors=false -D org.osgi.framework.bundle.parent=ext -D osgi.framework.extensions=org.eclipse.fx.osgi -D baselineMode=warn -D jgit.dirtyWorkingTree=warning -D tycho.localArtifacts=ignore -D csstudio.composite.repo=${REPO} -D skipTests=true
 - mvn clean verify -D eclipse.p2.mirrors=false -D org.osgi.framework.bundle.parent=ext -D osgi.framework.extensions=org.eclipse.fx.osgi -D baselineMode=warn -D jgit.dirtyWorkingTree=warning -D tycho.localArtifacts=ignore -D csstudio.composite.repo=${REPO} -D skipTests=true

after_failure:
 - find ./ -type d -name "surefire-reports" -print0 | xargs -0 -I {} find {} -iname "*.txt" -type f | xargs cat
 - find . -type f -name "*.log" -print0 -exec cat {} \;
